---
title: "Lasso and Cox Regression - Larger Dataset"
author: "Jiajun"
date: "1/9/2020"
output:
  rmdformats::readthedown:
    theme: sandstone
    highlight: tango
editor_options:
  chunk_output_type: inline
---

<style type="text/css">

h2 { /* Header 2 */
  font-size: 24px;
}

p { /* Normal Text */
  font-size: 18px;
}

code.r{ /* Code block */
    font-size: 8px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Library and Data

```{r load-library-and-data}
library(survival)
library(tidyverse)
library(penalized)

source("R/build_feature.R")
source("R/run_lasso.R")
source("R/run_cox.R")

library(readxl)
raw_data <- read_excel("data/Aim3-early-adversity-subjects-F-survival-2020-10-09.xlsx")
raw_data_larger <- read_excel("data/Aim3-early-adversity-subjects-F-survival-2021-01-07.xlsx")
```


## EDA

### Preprocess

```{r eda-check-na-and-data-types}
data <- preprocess(raw_data)
data_larger <- preprocess(raw_data_larger)
data_larger_sub <- data_larger[!data_larger$age_less_than_1, ]
```

### Prepare penalized covariates

```{r}
penalized_covariates <- get_penalized_covariates(data)
penalized_covariates_larger <- get_penalized_covariates(data_larger)
penalized_covariates_larger_sub <- get_penalized_covariates(data_larger_sub)
```


Done last time.

The censoring variable is `dead` and the predictors I use are

- six adversities, `adv_cumulative`
- interactions: `adv_mom:other adversity`, `adv_rain:other adversity`

## Results {.tabset .tabset-fade .tabset-pills}

### Smaller dataset

```{r smaller-dataset-lasso-results}
opt_lambda <- get_opt_lambda_of_lasso(
  data = data,
  covariates = penalized_covariates
)

final <- penalized(
  Surv(data$age, data$dead),
  penalized = penalized_covariates,
  standardize = T,
  lambda1 = opt_lambda,
  trace = F
)

nonzero_varnames <- names(final@penalized)[final@penalized != 0]

cox <- run_cox(
  data = data,
  nonzero_varnames = nonzero_varnames,
  penalized_covariates = penalized_covariates
)

summary(cox)
```


```{r kable-smaller-results, eval=FALSE, include=FALSE}
summary(cox)$coef %>%
  select("coef", "se(coef)") %>%
  round(., digits = 3) %>%
  DT::datatable(
    options = list(dom = 't'),
    caption = "Results: smaller dataset"
  )
```



### Larger dataset (complete)

```{r larger-dataset-lasso-results}
opt_lambda_larger <- get_opt_lambda_of_lasso(
  data = data_larger,
  covariates = penalized_covariates_larger
)

final_larger <- penalized(
  Surv(data_larger$age, data_larger$dead),
  penalized = penalized_covariates_larger,
  standardize = T,
  lambda1 = opt_lambda_larger,
  trace = F
)

nonzero_varnames_larger <- names(final_larger@penalized)[final_larger@penalized != 0]

cox_larger <- run_cox(
  data = data_larger,
  nonzero_varnames = nonzero_varnames_larger,
  penalized_covariates = penalized_covariates_larger
)

summary(cox_larger)
```


### Larger dataset (age > 1)

```{r larger-dataset-sub-lasso-results}
opt_lambda_larger_sub <- get_opt_lambda_of_lasso(
  data = data_larger_sub,
  covariates = penalized_covariates_larger_sub
)

final_larger_sub <- penalized(
  Surv(data_larger_sub$age, data_larger_sub$dead),
  penalized = penalized_covariates_larger_sub,
  standardize = T,
  lambda1 = opt_lambda_larger_sub,
  trace = F
)

nonzero_varnames_larger_sub <- names(final_larger_sub@penalized)[final_larger_sub@penalized != 0]

cox_larger_sub <- run_cox(
  data = data_larger_sub,
  nonzero_varnames = nonzero_varnames_larger_sub,
  penalized_covariates = penalized_covariates_larger_sub
)

summary(cox_larger_sub)
```


## Discussion

Compared to the smaller dataset, the increase of sample size has picked up more covariates and interaction terms, and more of them have shown statistical significance. Specifically for the complete larger dataset, main effects of `adv_mom`, `adv_sib` are selected and significant. In the meantime, interaction terms including `adv_mom:adv_mom_rank`, `adv_sib:adv_rain` are also selected with small p-value.



